# Human Analytics Patterns for Rails Logs
# Use with uber_scanner to extract meaningful user behavior

patterns:
  # ========================================
  # HUMAN TRAFFIC VALIDATION
  # ========================================
  # These patterns identify genuine human requests
  # (exclude lines matching bot patterns first)

  - name: "human_request"
    pattern: 'Started (GET|POST|PUT|PATCH|DELETE) "/(angels|donations|contacts|privacy_policies|cart|users|api/v1/fetch|printful_sync_products)?[^"]*" for (?!154\.83\.103\.|132\.226\.122\.|45\.148\.10\.|185\.177\.72\.|78\.153\.140\.)'

  # ========================================
  # PAGE VIEWS (GET Requests)
  # ========================================

  # Homepage
  - name: "homepage_view"
    pattern: 'Started GET "/" for [0-9.]+ at'

  # Main content sections
  - name: "angels_list_view"
    pattern: 'Started GET "/angels" for [0-9.]+ at'

  - name: "angel_detail_view"
    pattern: 'Started GET "/angels/[a-f0-9-]+" for [0-9.]+ at'

  - name: "donations_page_view"
    pattern: 'Started GET "/donations" for [0-9.]+ at'

  - name: "donation_new_view"
    pattern: 'Started GET "/donations/new" for [0-9.]+ at'

  - name: "contacts_page_view"
    pattern: 'Started GET "/contacts" for [0-9.]+ at'

  - name: "contact_new_view"
    pattern: 'Started GET "/contacts/new" for [0-9.]+ at'

  - name: "privacy_policy_view"
    pattern: 'Started GET "/privacy_policies' for [0-9.]+ at'

  - name: "cart_view"
    pattern: 'Started GET "/cart" for [0-9.]+ at'

  # ========================================
  # AUTHENTICATION FLOW
  # ========================================

  - name: "signin_page_view"
    pattern: 'Started GET "/users/sign_in" for [0-9.]+ at'

  - name: "signup_page_view"
    pattern: 'Started GET "/users/sign_up" for [0-9.]+ at'

  - name: "user_edit_view"
    pattern: 'Started GET "/users/edit" for [0-9.]+ at'

  - name: "password_reset_view"
    pattern: 'Started GET "/users/password/new" for [0-9.]+ at'

  - name: "password_edit_view"
    pattern: 'Started GET "/users/password/edit" for [0-9.]+ at'

  # ========================================
  # USER ACTIONS (POST/PUT/PATCH)
  # ========================================

  # Authentication actions
  - name: "user_signin_attempt"
    pattern: 'Started POST "/users/sign_in" for [0-9.]+ at'

  - name: "user_signup_attempt"
    pattern: 'Started POST "/users" for [0-9.]+ at'

  - name: "user_signout"
    pattern: 'Started DELETE "/users/sign_out" for [0-9.]+ at'

  - name: "password_reset_request"
    pattern: 'Started POST "/users/password" for [0-9.]+ at'

  - name: "password_update"
    pattern: 'Started (PUT|PATCH) "/users/password" for [0-9.]+ at'

  - name: "user_profile_update"
    pattern: 'Started (PUT|PATCH) "/users" for [0-9.]+ at'

  # Content creation/submission
  - name: "angel_submission"
    pattern: 'Started POST "/angels" for [0-9.]+ at'

  - name: "angel_update"
    pattern: 'Started (PUT|PATCH) "/angels/[a-f0-9-]+" for [0-9.]+ at'

  - name: "angel_delete"
    pattern: 'Started DELETE "/angels/[a-f0-9-]+" for [0-9.]+ at'

  - name: "donation_attempt"
    pattern: 'Started POST "/donations" for [0-9.]+ at'

  - name: "contact_form_submission"
    pattern: 'Started POST "/contacts" for [0-9.]+ at'

  # Cart actions
  - name: "cart_item_add"
    pattern: 'Started POST "/cart_items" for [0-9.]+ at'

  - name: "cart_item_update"
    pattern: 'Started (PUT|PATCH) "/cart_items/[0-9]+" for [0-9.]+ at'

  - name: "cart_item_remove"
    pattern: 'Started DELETE "/cart_items/[0-9]+" for [0-9.]+ at'

  - name: "cart_empty"
    pattern: 'Started DELETE "/cart/empty" for [0-9.]+ at'

  # ========================================
  # CONVERSION EVENTS
  # ========================================

  - name: "donation_success"
    pattern: 'Started GET "/donations/success" for [0-9.]+ at'

  - name: "donation_cancel"
    pattern: 'Started GET "/donations/cancel" for [0-9.]+ at'

  - name: "stripe_webhook"
    pattern: 'Started POST "/webhooks/stripe" for [0-9.]+ at'

  # ========================================
  # API USAGE
  # ========================================

  - name: "api_fetch"
    pattern: 'Started GET "/api/v1/fetch" for [0-9.]+ at'

  - name: "printful_sync_view"
    pattern: 'Started GET "/printful_sync_products' for [0-9.]+ at'

  # ========================================
  # PERFORMANCE INDICATORS
  # ========================================

  # Successful responses
  - name: "success_200"
    pattern: 'Completed 200 OK in \d+ms'

  - name: "success_201"
    pattern: 'Completed 201 Created in \d+ms'

  - name: "redirect_302"
    pattern: 'Completed 302 Found in \d+ms'

  # Client errors
  - name: "not_found_404"
    pattern: 'Completed 404 Not Found in \d+ms'

  - name: "unauthorized_401"
    pattern: 'Completed 401 Unauthorized in \d+ms'

  - name: "forbidden_403"
    pattern: 'Completed 403 Forbidden in \d+ms'

  - name: "unprocessable_422"
    pattern: 'Completed 422 Unprocessable Entity in \d+ms'

  # Server errors
  - name: "server_error_500"
    pattern: 'Completed 500 Internal Server Error in \d+ms'

  # Slow requests
  - name: "slow_request_warning"
    pattern: 'Completed \d+ \w+ in ([5-9]\d{3}|[1-9]\d{4,})ms'  # >5000ms

  - name: "very_slow_request"
    pattern: 'Completed \d+ \w+ in ([1-9]\d{5,})ms'  # >10000ms

  # ========================================
  # USER JOURNEY TRACKING
  # ========================================

  # Common conversion paths
  - name: "homepage_to_angels"
    pattern: 'Started GET "/" for ([0-9.]+) at.*\n.*Started GET "/angels" for \1 at'

  - name: "homepage_to_donations"
    pattern: 'Started GET "/" for ([0-9.]+) at.*\n.*Started GET "/donations" for \1 at'

  - name: "angels_to_submission"
    pattern: 'Started GET "/angels" for ([0-9.]+) at.*\n.*Started POST "/angels" for \1 at'

  - name: "signup_flow_complete"
    pattern: 'Started GET "/users/sign_up" for ([0-9.]+) at.*\n.*Started POST "/users" for \1 at'

  # ========================================
  # SESSION ANALYSIS
  # ========================================

  # Session patterns (requires request ID tracking)
  - name: "session_start"
    pattern: '\[([a-f0-9-]+)\] Started GET "/" for [0-9.]+ at'

  - name: "deep_session"
    pattern: '\[([a-f0-9-]+)\] Started (GET|POST).*\n.*\[\1\].*\n.*\[\1\].*\n.*\[\1\].*\n.*\[\1\]'  # 5+ requests in same session

  # ========================================
  # FORM INTERACTIONS
  # ========================================

  # Form validation errors (often precede successful submission)
  - name: "form_validation_error"
    pattern: 'Completed 422 Unprocessable Entity.*\n.*Parameters:'

  # Successful form submissions after errors
  - name: "retry_success"
    pattern: 'Completed 422.*for ([0-9.]+) at.*\n.*Completed 20[01].*for \1 at'

  # ========================================
  # BOT EXCLUSION PATTERNS
  # ========================================
  # Use these to explicitly exclude bot traffic

  - name: "exclude_bot_scanner"
    pattern: 'Started (GET|POST) "[^"]*\.(php|asp|jsp|env|xml|sql|bak|old|zip|tar|gz)'

  - name: "exclude_wordpress_scanner"
    pattern: 'Started (GET|POST) "[^"]*(wp-admin|wp-login|wordpress|wp-content)'

  - name: "exclude_common_exploits"
    pattern: 'Started (GET|POST) "[^"]*(phpmyadmin|phpinfo|\.git|config\.php|eval-stdin|shell)'

  - name: "exclude_bot_ips"
    pattern: 'for (154\.83\.103\.|132\.226\.122\.|45\.148\.10\.|185\.177\.72\.|78\.153\.140\.|93\.123\.109\.|52\.169\.161\.|129\.146\.124\.|138\.91\.59\.|194\.50\.16\.|195\.178\.110\.|104\.28\.240\.|194\.233\.72\.) at'